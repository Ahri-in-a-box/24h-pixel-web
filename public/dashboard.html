<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas</title>

    <!-- #region Imports CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/bootstrap.overrides.css">
    <link rel="stylesheet" href="lib/custom-icons/custom-icons.css">
    <link href="https://cdn.datatables.net/v/bs5/dt-2.0.3/fh-4.0.1/sc-2.4.1/sl-2.0.0/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css" integrity="sha512-ELV+xyi8IhEApPS/pSj66+Jiw+sOT1Mqkzlh8ExXihe4zfqbWkxPRi8wptXIO9g73FSlhmquFlUOuMSoXz5IRw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- #endregion Imports CSS -->
</head>
<body class="vh-100 vw-100 d-flex">
    <div class="col-2 bg-dark left-nav-panel p-4">
        <div class="h-100 d-flex flex-column justify-content-center gap-5">
            <a href="place.html" class="btn btn-light btn-nav"><em class="custom-icon plus"></em> Placez !</a>
            <a class="btn btn-light btn-nav active"><em class="custom-icon view-grid"></em> Dashboard</a>
            <a class="btn btn-light btn-nav"><em class="custom-icon chart-bar"></em> Statistiques</a>
            <a class="btn btn-light btn-nav"><em class="custom-icon collection"></em> Calques</a>
        </div>
    </div>
    <div class="d-flex flex-column gap-4 col p-4">
        <h1>Dashboard</h1>
        <div class="d-flex align-items-center gap-3 p-2 rounded-pill bg-primary-lighter">
            <div class="bg-light rounded-circle p-2 ">
                <em class="custom-icon icon-sm flag"></em>
            </div>
            <p class="fw-bolder fs-4"><span id="pixels" class="placeholder">0000000 / 0000000</span></p>
            <button class="ms-auto btn btn-large btn-outline-primary rounded-pill">Placez un calque</button>
            <button class="btn btn-large btn-primary rounded-pill">Placez vos pixels</button>
        </div>
        <div class="d-flex flex-grow-1 gap-32"> 
            <div class="col-7 d-flex flex-column gap-32">

                <!-- #region Workers Infos -->
                <div class="d-flex flex-column gap-32 p-32 rounded-5 bg-primary-lighter">
                    <div class="d-flex gap-64">
                        <div class="d-flex flex-column">
                            <p class="fw-bold">Mes</p>
                            <p class="fw-bold fs-2">Workers</p>
                        </div>
                        <div class="ms-auto d-flex flex-column">
                            <p id="worker-ready" class="fw-bold fs-2">50</p>
                            <p class="text-secondary">Workers prêts</p>
                        </div>
                        <div class="d-flex flex-column">
                            <p id="worker-busy" class="fw-bold fs-2">0</p>
                            <p class="text-secondary">Workers indisponibles</p>
                        </div>
                    </div>
                    <div id="workers-grid" class="d-flex flex-wrap gap-3">

                    </div>
                </div>
                <!-- #endregion Workers Infos -->

                <!-- #region Layers Infos -->
                <div class="d-flex flex-column flex-grow-1 gap-3 p-32 rounded-5 bg-primary-lighter">
                    <div class="d-flex align-items-center">
                        <div>
                            <p class="fw-bold">Mes</p>
                            <p class="fw-bold fs-2">Calques</p>
                        </div>
                        <div id="add-layer" class="ms-auto btn btn-primary rounded-pill">Ajouter</div>
                    </div>
                    <div id="layers-table-wrapper" class="flex-grow-1">
                        <table id="layers-table" class="table table-hover custom-table">
                        
                        </table>
                    </div>
                </div>   
                <!-- #endregion Layers Infos -->
                
            </div>
            <div class="col d-flex flex-column bg-white gap-1 p-32 rounded-5">
                <!-- #region Equipes Infos -->
                <div class="d-flex align-items-end">
                    <div>
                        <p class="fw-bold">Les</p>
                        <p class="fw-bold fs-2">Équipes</p>
                    </div>
                    <div class="d-flex gap-2 ms-auto">
                        <p class="fw-bold">Le plus de pixels</p>
                        <em id="team-list-sort-icon" role="button" class="custom-icon arrow-down" onclick="reverseTeamList()"></em>
                    </div>
                </div>
                <div id="teams-list" class="d-flex flex-column flex-grow-1 gap-3 pe-3 overflow-auto">

                </div>
                <!-- #endregion Equipes Infos -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal" data-backdrop="static" tabindex="-1" role="dialog" aria-hidden="true"></div>
</body>
<!-- #region Imports JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
    crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/v/dt/dt-2.0.3/datatables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js" integrity="sha512-57oZ/vW8ANMjR/KQ6Be9v/+/h6bq9/l3f0Oc7vn6qMqyhvPd1cvKBRWWpzu0QoneImqr2SkmO4MSqU+RpHom3Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>
<!-- #endregion Imports JS -->

<script>
    var layersDataTable;

    $(document).ready(() => {
        generateWorkersGrid();
        initLayersTable();
        populateTeamList();

        $("#add-layer").on("click", _ => showLayer());
        const socket = io("localhost:8081");
        socket.on("workers/updated", w => resetWorkerAvailability(w.workerId, 10000));
    });

    function generateWorkersGrid() {
        const $workerGrid = $('#workers-grid');
        const $workerReady = $('#worker-ready');
        const $workerBusy = $('#worker-busy');

        $.ajax({
            url: '/api/workers',
            success: function(result) {
                result.forEach(x => {
                    const $workerElem = constructWorkerElemForGrid(x.id);
                    $workerGrid.append($workerElem);

                    if (!x.free) {
                        resetWorkerAvailability(x.id, x.cooldown * 1000)
                    }
                });
            }
        });
    }

    function constructWorkerElemForGrid(id) {
        const $worker = $('<span>').addClass('worker-grid-elem rounded-3').attr('workerId', id);
        return $worker;
    }

    function resetWorkerAvailability(id, cooldown) {
        const $workerNode = $(`span[workerId=${id}]`);

        const $workerReady = $('#worker-ready');
        const $workerBusy = $('#worker-busy');

        let available = parseInt($workerReady.text()) - 1;
        $workerReady.text(available);
        $workerBusy.text(50 - available);

        $workerNode.css('background-color', 'var(--secondary-10)');
        $workerNode.animate({
            backgroundColor: "#FCA250"
        }, cooldown, function() {
            let available = parseInt($workerReady.text()) + 1;
            $workerReady.text(available);
            $workerBusy.text(50 - available);
        });
    }

    function populateTeamList() {
        const $teamsList = $('#teams-list');
        $teamsList.css('max-height', $teamsList.outerHeight());
        
        $.ajax({
            type: 'POST',
            url: '/api/war',
            contentType: 'application/json',
            data: JSON.stringify({ Id: 1 }),
            success: function(result) {
                result = JSON.parse(result);
                result.teams.forEach(x => {
                    const $teamElem = $('<div>');
                    const $textRow = $('<div>').addClass('d-flex justify-content-between mb-1');
                    $textRow.append($('<p>').text(`${x.name} (${x.id})`));
                    $textRow.append($('<p>').addClass('fw-bold').text(`${x.pixels}`));

                    $progressWrapper = $('<div>').addClass('progress rounded-pill').height(16);
                    $progressBar = $('<div class="progress-bar rounded-pill" role="progressbar"></div>').css('width', `${(x.pixels / result.totalPixels) * 100}%`)
                    $progressWrapper.append($progressBar);

                    $teamElem.append($textRow);
                    $teamElem.append($progressWrapper);

                    $teamsList.append($teamElem);
                });

                const team = result.teams.find(x => x.id == 6);
                $("#pixels").text(`${team.pixels} / ${result.totalPixels}`)
                    .removeClass("placeholder");
            }
        });
    }

    function reverseTeamList() {
        const $teamsList = $('#teams-list');
        $teamsList.toggleClass('flex-column-reverse').toggleClass('flex-column');

        $('#team-list-sort-icon').toggleClass('rotate-180');
    }

    function initLayersTable() {
        const $table = $('#layers-table');
        const availableSpace = $('#layers-table-wrapper').outerHeight();

        $.ajax({
            url: '/layers',
            success: function(result) {
                layersDataTable = $table.DataTable({
                    layout: {
                        topStart: null,
                        topEnd: null,
                        bottomStart: null,
                    },
                    paging: false,
                    scrollY: availableSpace - 60,
                    data: result,
                    columns: [
                        {  
                            title: "Nom",
                            data: "Name",
                            render: function(data, type, row) {
                                if (type == "display") {
                                    return `<div class="d-flex align-items-center gap-2"><img class="layer-table-image" src="/layers/${row.Image}"></img>${data}</div>`
                                }

                                return data;
                            }
                        },
                        {
                            title: "Chunk",
                            data: "Chunk"
                        },
                        {
                            title: "Worker",
                            data: "NbWorkers"
                        },
                        {
                            title: "Status",
                            data: "IsActive",
                            render: function(data, type) {
                                if (type == "display") {
                                    if (!data) {
                                        return '<button class="btn btn-outline-dark rounded-pill">Inactif</button>'
                                    } else {
                                        return '<button class="btn btn-primary rounded-pill">Actif</button>'
                                    }

                                    
                                }

                                return data;
                            }
                        }
                    ]
                });
            }
        });
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
        });
    }

    function closeModal() {
        $('#modal').modal('hide');
    }

    function showLayer(id) {
        $.ajax({
            url: "/layers/get",
            contentType: 'application/json',
            data: JSON.stringify({ Id: id }),
            type: 'POST',
            success: function (result) {
                $.ajax({
                    url: "/_layer.html",
                    contentType: 'application/json',
                    data: JSON.stringify({ Id: id }),
                    type: 'POST',
                    success: function (html) {
                        $('#modal').html(html)
                            .modal('show');

                        if(!result) {
                            Object.entries(result)
                                .forEach(([key, val]) => $(`#modal #${key}`).val(val))
                        }
                    }
                });
            }
        });
    }

    async function saveLayer() {
        let data = {};
        $("#layer-form input[type!=file]").toArray().forEach(x => data[x.getAttribute("name")] = x.value);
        const promises = $("#layer-form input[type=file]").toArray()
            .map(x => new Promise(async resolve => {
                data[x.getAttribute("name")] = await toBase64(x.files[0]);
                resolve();
            })
        );
        await Promise.all(promises);
        data.ImageExt = "." + $("#layer-form input[type=file]")[0].files[0].type.split("/")[1];

        $.ajax({
            url: "/layers/save",
            contentType: 'application/json',
            data: JSON.stringify(data),
            type: 'POST',
            success: function (result) {
                console.log(result);

                if (data.id) {
                    layersDataTable.rows.add([result], true);
                } else {
                    layersDataTable.rows.update(result, $(`#layers-table tbody tr [id='${result.Id}']`), null, true);
                }

                closeModal();
            }
        });
    }

    function test() {
        const $worker = $(".worker-grid-elem[workerid=2]");
        
        $worker.css('background-color', 'var(--secondary-10)');
        $worker.animate({
            backgroundColor: "#FCA250"
        }, 10000);
    }
</script>
</html>